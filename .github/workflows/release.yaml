---
name: Release `jq` latest as WASM

run-name: 'Release `jq` latest as WASM (from: ${{ github.ref }})'

on:
  workflow_call:
  workflow_dispatch:

jobs:
  job-a:
    runs-on: ubuntu-latest
    steps:
      - name: 'Install build requirement: `emscripten`'
        run: |
          git clone https://github.com/emscripten-core/emsdk.git
          cd emsdk
          ./emsdk install latest
          ./emsdk activate latest
          source ./emsdk_env.sh

      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: 'Verify build requirement: `emscripten`'
        run: |
          emcc -v

      - name: 'Prep the `jq` module'
        run: |
          git submodule update --init
          autoreconf -i
          emconfigure ./configure --with-oniguruma=builtinrun
          emmake make LDFLAGS=-all-static
          cp jq jq.o
        working-directory: jq

      - name: 'Try to do the thing with the `jq` module'
        run: |
          emcc jq.o -o jq.js -s ERROR_ON_UNDEFINED_SYMBOLS=0
        working-directory: jq

      - name: Create test data
        id: test-data
        run: |
          tmpfile=$(mktemp)
          echo '{ "a": "b" }' > $tmpfile
          echo "json=$tmpfile" | tee -a $GITHUB_OUTPUT

      - env:
          JSON_FILE: ${{ steps.test-data.outputs.json }}
        run: |
          node jq/jq.js '.a' $JSON_FILE
